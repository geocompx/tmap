{
  "hash": "d3e89ba42bbf8d68bce92f868637f28f",
  "result": {
    "engine": "knitr",
    "markdown": "\n::: {.cell}\n\n:::\n\n\n# Charts {#sec-charts}\n\nThematic maps usually represent one or more variables using colors, shapes, or sizes.\nThen, the map legend is used to explain the meaning of these visual variables (@sec-legends).\nSuch a legend can be expanded (or even replaced, @sec-charts-customization) with a chart that provides more information about the distribution of the variable values.\n\nThe **tmap** package provides several chart types that can be used in the map legend (@tbl-layers-table).\nThey are specified in one of the `*.chart` arguments of a layer function, e.g., `fill.chart` of `tm_polygons()`, `size.chart` of `tm_dots()`, etc.\nThe use of a chart type depends on the type of data we want to represent, i.e., whether it is numerical or categorical, and whether it is univariate or bivariate.\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n<!-- Martijn, why do we need `tm_chart_none()`? -->\n\n\n::: {#tbl-layers-table .cell layout-align=\"center\" tbl-cap='Available chart types.'}\n::: {.cell-output-display}\n\n```{=html}\n<!-- preamble start -->\n\n    <script>\n\n      function styleCell_lbzwpy41b8f1ocz3enr9(i, j, css_id) {\n          var table = document.getElementById(\"tinytable_lbzwpy41b8f1ocz3enr9\");\n          var cell = table.querySelector(`[data-row=\"${i}\"][data-col=\"${j}\"]`);\n          if (cell) {\n              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);\n              cell.classList.add(css_id);\n          } else {\n              console.warn(`Cell at (${i}, ${j}) not found.`);\n          }\n      }\n      function insertSpanRow(i, colspan, content) {\n        var table = document.getElementById('tinytable_lbzwpy41b8f1ocz3enr9');\n        // Find the row with data-row attribute matching i\n        var targetRow = table.querySelector(`tr [data-row=\"${i}\"]`).closest('tr');\n        var newRow = table.insertRow(targetRow.rowIndex);\n        var newCell = newRow.insertCell(0);\n        newCell.setAttribute(\"colspan\", colspan);\n        newCell.setAttribute(\"data-col\", \"0\");\n        newCell.setAttribute(\"data-row\", i - 1);\n        // newCell.innerText = content;\n        // this may be unsafe, but innerText does not interpret <br>\n        newCell.innerHTML = content;\n      }\n      function spanCell_lbzwpy41b8f1ocz3enr9(i, j, rowspan, colspan) {\n        var table = document.getElementById(\"tinytable_lbzwpy41b8f1ocz3enr9\");\n        const targetCell = table.querySelector(`[data-row=\"${i}\"][data-col=\"${j}\"]`);\n        if (!targetCell) {\n          console.warn(`Cell at (${i}, ${j}) not found.`);\n        }\n\n        // Get all cells that need to be removed\n        const cellsToRemove = [];\n        for (let r = 0; r < rowspan; r++) {\n          for (let c = 0; c < colspan; c++) {\n            if (r === 0 && c === 0) continue; // Skip the target cell\n            const cell = table.querySelector(`[data-row=\"${i + r}\"][data-col=\"${j + c}\"]`);\n            if (cell) {\n              cellsToRemove.push(cell);\n            }\n          }\n        }\n\n        // Remove all cells\n        cellsToRemove.forEach(cell => cell.remove());\n\n        // Set rowspan and colspan of the target cell if it exists\n        if (targetCell) {\n          targetCell.rowSpan = rowspan;\n          targetCell.colSpan = colspan;\n        }\n      }\n      // tinytable span after\n      window.addEventListener('load', function () {\n          var cellsToStyle = [\n            // tinytable style arrays after\n          { positions: [ { i: '7', j: 1 },  ], css_id: 'tinytable_css_4io4fd32jm8lxpo8i2z1',}, \n          { positions: [ { i: '0', j: 1 },  ], css_id: 'tinytable_css_lvaok9ny0cmnuu9v1ub7',}, \n          { positions: [ { i: '7', j: 0 },  ], css_id: 'tinytable_css_fj8i7a6pgov4iz0dghed',}, \n          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 },  ], css_id: 'tinytable_css_hriimk9js5kju5lj4j71',}, \n          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_8upsikl2m15eul1rzwm6',}, \n          ];\n\n          // Loop over the arrays to style the cells\n          cellsToStyle.forEach(function (group) {\n              group.positions.forEach(function (cell) {\n                  styleCell_lbzwpy41b8f1ocz3enr9(cell.i, cell.j, group.css_id);\n              });\n          });\n      });\n    </script>\n\n    <style>\n      /* tinytable css entries after */\n      .table td.tinytable_css_4io4fd32jm8lxpo8i2z1, .table th.tinytable_css_4io4fd32jm8lxpo8i2z1 { border-bottom: solid #d3d8dc 0.1em; }\n      .table td.tinytable_css_lvaok9ny0cmnuu9v1ub7, .table th.tinytable_css_lvaok9ny0cmnuu9v1ub7 { border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }\n      .table td.tinytable_css_fj8i7a6pgov4iz0dghed, .table th.tinytable_css_fj8i7a6pgov4iz0dghed { font-family: monospace; border-bottom: solid #d3d8dc 0.1em; }\n      .table td.tinytable_css_hriimk9js5kju5lj4j71, .table th.tinytable_css_hriimk9js5kju5lj4j71 { font-family: monospace; }\n      .table td.tinytable_css_8upsikl2m15eul1rzwm6, .table th.tinytable_css_8upsikl2m15eul1rzwm6 { font-family: monospace; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }\n    </style>\n    <div class=\"container\">\n      <table class=\"table table-borderless\" id=\"tinytable_lbzwpy41b8f1ocz3enr9\" style=\"width: auto; margin-left: auto; margin-right: auto;\" data-quarto-disable-processing='true'>\n        <thead>\n        \n              <tr>\n                <th scope=\"col\" data-row=\"0\" data-col=\"0\">Function</th>\n                <th scope=\"col\" data-row=\"0\" data-col=\"1\">Description</th>\n              </tr>\n        </thead>\n        \n        <tbody>\n                <tr>\n                  <td data-row=\"1\" data-col=\"0\">tm_chart_histogram()</td>\n                  <td data-row=\"1\" data-col=\"1\">Histogram</td>\n                </tr>\n                <tr>\n                  <td data-row=\"2\" data-col=\"0\">tm_chart_box()</td>\n                  <td data-row=\"2\" data-col=\"1\">Box plot</td>\n                </tr>\n                <tr>\n                  <td data-row=\"3\" data-col=\"0\">tm_chart_violin()</td>\n                  <td data-row=\"3\" data-col=\"1\">Violin plot</td>\n                </tr>\n                <tr>\n                  <td data-row=\"4\" data-col=\"0\">tm_chart_bar()</td>\n                  <td data-row=\"4\" data-col=\"1\">Bar chart</td>\n                </tr>\n                <tr>\n                  <td data-row=\"5\" data-col=\"0\">tm_chart_donut()</td>\n                  <td data-row=\"5\" data-col=\"1\">Donut chart</td>\n                </tr>\n                <tr>\n                  <td data-row=\"6\" data-col=\"0\">tm_chart_heatmap()</td>\n                  <td data-row=\"6\" data-col=\"1\">Heatmap</td>\n                </tr>\n                <tr>\n                  <td data-row=\"7\" data-col=\"0\">tm_chart_none()</td>\n                  <td data-row=\"7\" data-col=\"1\">No chart</td>\n                </tr>\n        </tbody>\n      </table>\n    </div>\n<!-- hack to avoid NA insertion in last line -->\n```\n\n:::\n:::\n\n\nFor the examples in this chapter, we will use the Slovenian regions dataset that contains information about the population density, region group, and the percentage of the population aged 65 or more in each region.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tmap)\nlibrary(sf)\nslo_regions = read_sf(\"data/slovenia/slo_regions.gpkg\")\n```\n:::\n\n\n## Numerical data\n\nThe first group of charts is used for numerical data, i.e., data that can take any value within a range.\nIt includes histograms, box plots, violin plots, and donut charts.\n\nHistograms are the most common chart type used to represent the distribution of a numerical variable.\nThey show how often each range of values occurs in the data -- helping to understand which values are more common and if there are any outliers.\nTo add a histogram to the map, we use the `tm_chart_histogram()` function in the `fill.chart` argument of the `tm_polygons()` function (@fig-chart-hist-1).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntm_shape(slo_regions) +\n  tm_symbols(fill = \"pop_dens\",\n             fill.chart = tm_chart_histogram())\n```\n:::\n\n\nSuch a histogram, like other charts, is automatically placed along the map legend.\nHowever, we can position them independently of the map legend using the `position` argument of the `tm_chart_*()` and `tm_legend()` functions (@fig-chart-hist-2).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_histogram(\n                position = tm_pos_out(\"left\", \"center\")\n                ),\n              fill.legend = tm_legend(\n                position = tm_pos_out(\"right\", \"center\")\n                )\n              )\n```\n:::\n\n\n\n::: {#fig-chart-hist .cell layout-nrow=\"2\" layout-align=\"center\"}\n::: {.cell-output-display}\n![Default histogram](figures/fig-chart-hist-1.png){#fig-chart-hist-1 fig-align='center' width=100%}\n:::\n\n::: {.cell-output-display}\n![Repositioned histogram](figures/fig-chart-hist-2.png){#fig-chart-hist-2 fig-align='center' width=100%}\n:::\n\nHistogram added to a map to represent the distribution of a variable.\n:::\n\n\n@fig-chart-num shows additional three chart types that can be used for numerical data: box plots, violin plots, and donut charts.\nThey can be added to the map using the `tm_chart_box()`, `tm_chart_violin()`, and `tm_chart_donut()` functions, respectively.\nAs you may notice, these charts show similar messages, e.g., than the middle value range is the most common.\nOn the other hand, box plots directly show the median and quartiles of the data, violin plots also show the density of the data distribution, and donut charts show the proportions of the data.\nThey also have different aesthetics.\nThus, the choice of the chart type depends on the message we want to convey and the aesthetics we prefer.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# box plot\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_box())\n# violin plot\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_violin())\n# donut plot\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_donut())\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Charts for numerical data.](figures/fig-chart-num-1.png){#fig-chart-num fig-align='center' width=100%}\n:::\n:::\n\n\n## Categorical data\n\nThe second group of charts is used for categorical data -- which can take only a limited number of values.\nIt includes bar charts (`tm_chart_donut()`) and donut charts (`tm_chart_bar()`): bar charts show the frequency of each category, while donut charts show the proportions of each category (@fig-chart-cat).\nIn the examples below, we represent the region groups of each region in Slovenia and observe that there are more regions in the \"Central\" and \"West\" groups than in the others.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"region_group\",\n              fill.chart = tm_chart_donut())\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"region_group\",\n              fill.chart = tm_chart_bar())\n```\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Charts for categorical data.](figures/fig-chart-cat-1.png){#fig-chart-cat fig-align='center' width=100%}\n:::\n:::\n\n\n## Bivariate data\n\nThe third group of charts is used for bivariate data, i.e., data that contains two variables.\nIt includes a heatmap chart (`tm_chart_heatmap()`) that shows how often each combination of values occurs in the data (@fig-chart-bivariate).\n<!-- one more sentence? -->\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntm_shape(slo_regions) +\n  tm_polygons(fill = tm_vars(c(\"pop_dens\", \"pop65perc\"), multivariate = TRUE),\n              fill.scale = tm_scale_bivariate(values = \"purplegold\"),\n              fill.chart = tm_chart_heatmap())\n```\n\n::: {.cell-output-display}\n![Bivariate charts used in case of representing a relationship between two numerical variables.](figures/fig-chart-bivariate-1.png){#fig-chart-bivariate fig-align='center' width=100%}\n:::\n:::\n\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n## Additional chart customization {#sec-charts-customization}\n\nAll of the charts are directly based on the visual variables from the map layer and then created using the **ggplot2** package.\nBy default, however, the charts are much simplified, not showing all the details that **ggplot2** can provide, such as axis labels, titles, and various theme elements.\n<!-- with ggplot2 package and/or book reference -->\n<!-- https://github.com/geocompx/tmap/issues/10#issuecomment-3007409988 -->\n\nAt the same time, we may want to customize the charts to fit our map design better or to add more information.\nThis can be done with additional arguments of the `tm_chart_*()` functions, such as `plot.axis.x`, `plot.axis.y`, and `extra.ggplot2`.\nThe first two are logical arguments that control whether the x and y axes are shown in the chart, respectively.\nThe last one, `extra.ggplot2`, is a list of additional **ggplot2** functions that are applied to the chart -- for example, we may want to change the aesthetics of the chart, such as the background color as shown in @fig-chart-ggplot1.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(ggplot2)\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_histogram(\n                plot.axis.x = FALSE,\n                extra.ggplot2 = list(theme(plot.background = element_rect(fill = \"lightgray\")))\n              ))\n```\n\n::: {.cell-output-display}\n![Customizing charts with ggplot2.](figures/fig-chart-ggplot1-1.png){#fig-chart-ggplot1 fig-align='center' width=100%}\n:::\n:::\n\n\n@fig-chart-ggplot2 shows a more advanced modification of the chart.\nIt adds x and y axes, next, it adds a title to the chart, flips the chart coordinates, and changes the chart background color and title size.\nNext, it moves the chart to the top left corner of the map and sets its width.\nHaving such a customized chart provides all of the important map context information: variable name, unit, ranges of the values and their related colors.\nThus, we can treat it as a map legend and remove the default legend using `fill.legend = tm_legend(show = FALSE)`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntm_shape(slo_regions) +\n  tm_polygons(fill = \"pop_dens\",\n              fill.chart = tm_chart_histogram(\n                plot.axis.x = TRUE,\n                plot.axis.y = TRUE,\n                extra.ggplot2 = list(labs(title = \"Population density (people/sq. km)\"),\n                                     coord_flip(),\n                                     theme(plot.background = element_rect(fill = \"#FFC067\"),\n                                           plot.title = ggplot2::element_text(size = 10))),\n                position = tm_pos_in(\"LEFT\", \"TOP\"),\n                width = 20,\n              ),\n              fill.legend = tm_legend(show = FALSE))\n```\n\n::: {.cell-output-display}\n![Using chart as a map legend.](figures/fig-chart-ggplot2-1.png){#fig-chart-ggplot2 fig-align='center' width=100%}\n:::\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}